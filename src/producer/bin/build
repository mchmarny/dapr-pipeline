#!/bin/bash

set -o errexit
set -o pipefail

go mod tidy
go mod vendor

RELEASE_VERSION="v0.3.1"

go mod tidy
go mod vendor

CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build -a -tags netgo -ldflags \
'-w -extldflags "-static" -X main.AppVersion=${RELEASE_VERSION}' \
-mod vendor -o ../../bin/producer

CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -a -tags netgo -ldflags \
'-w -extldflags "-static" -X main.AppVersion=${RELEASE_VERSION}' \
-mod vendor -o ../../bin/producer-linux

CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build -a -tags netgo -ldflags \
'-w -extldflags "-static" -X main.AppVersion=${RELEASE_VERSION}' \
-mod vendor -o ../../bin/producer-windows

yes | cp -f ./components/producer.yaml ../../components/producer.yaml